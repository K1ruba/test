trigger:
  branches:
    include:
      - main

variables:
  imageName: 'apache-app'
  acrName: 'testingcr'
  acrLoginServer: 'testingcr.azurecr.io'
  tag: '$(Build.BuildId)'
  imageFullName: '$(acrLoginServer)/$(imageName):$(tag)'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker Image
    jobs:
      - job: BuildAndPush
        pool:
          name: minato
        steps:
          - checkout: self
          - script: |
              sudo docker build -t $(imageFullName) -f $(Build.SourcesDirectory)/Dockerfile $(Build.SourcesDirectory)
              echo $(ACR_PASSWORD) | sudo docker login $(acrLoginServer) -u $(ACR_USERNAME) --password-stdin
              sudo docker push $(imageFullName)
            displayName: 'Build and Push Docker Image (with sudo)'

          - task: Docker@2
            displayName: Build and Push Image to ACR
            inputs:
              containerRegistry: 'acr_pipeline'  
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '**/Dockerfile'
              tags: |
                $(tag)

  - stage: Deploy
    displayName: Deploy to Kubernetes
    dependsOn: BuildAndPush
    jobs:
      - job: DeployToK8s
        displayName: Deploy to AKS
        pool:
          name: minato  
        steps:
          - task: KubernetesManifest@0
            displayName: Deploy to AKS
            inputs:
              action: deploy
              kubernetesServiceConnection: 'yuno'
              namespace: default
              manifests: |
                $(Build.SourcesDirectory)/deployment.yaml
                $(Build.SourcesDirectory)/service.yaml
              containers: |
                $(imageFullName)


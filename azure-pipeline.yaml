trigger:
  branches:
    include:
      - main

variables:
  imageName: 'apache-app'
  acrName: 'testingcr'
  acrLoginServer: 'testingcr.azurecr.io'
  tag: '$(Build.BuildId)'
  imageFullName: '$(acrLoginServer)/$(imageName):$(tag)'

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker Image
    jobs:
      - job: BuildAndPush
        pool:
          name: Default
        steps:
          - checkout: self
          - script: |
              sudo docker build -t $(imageFullName) -f $(Build.SourcesDirectory)/Dockerfile $(Build.SourcesDirectory)
              echo $(ACR_PASSWORD) | sudo docker login $(acrLoginServer) -u $(ACR_USERNAME) --password-stdin
              sudo docker push $(imageFullName)
            displayName: 'Build and Push Docker Image (with sudo)'

  - stage: Deploy
    displayName: Deploy to Kubernetes
    dependsOn: BuildAndPush
    jobs:
      - job: DeployToK8s
        displayName: Deploy to AKS
        pool:
          name: Default  
        steps:
          - task: KubernetesManifest@1
            displayName: Deploy to AKS
            inputs:
              action: deploy
              kubernetesServiceConnection: 'yuno'
              namespace: default
              manifests: |
                $(Build.SourcesDirectory)/deployment.yaml
                $(Build.SourcesDirectory)/service.yaml
              containers: |
                $(imageFullName)

